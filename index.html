<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Radar Caça ao Tesouro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #111;
            color: #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }
        #radar {
            width: 300px;
            height: 300px;
            border: 2px solid #0f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            transition: transform 0.5s ease-in-out; 
        }
        #seta {
            width: 0;
            height: 0;
            border-left: 30px solid transparent;
            border-right: 30px solid transparent;
            border-bottom: 100px solid #0f0;
            transform-origin: 50% 100%;
        }
        #distancia {
            font-size: 2.5em; 
            font-weight: bold;
            color: #0f0;
        }
        #direcao-texto, #status-cacador, #status-tesouro {
            font-size: 1.1em;
            color: #ccc;
        }
    </style>
</head>
<body>

    <h1>Radar - Caça ao Tesouro</h1>
    <div id="radar">
        <div id="seta"></div>
    </div>
    <div id="distancia">--- m</div>
    <div id="direcao-texto">Calculando...</div>
    <hr style="width: 80%;">
    <div id="status-cacador">Status Caçador (Celular): ...</div>
    <div id="status-tesouro">Status Tesouro (LoRa): ...</div>

    <script>
      
        // URL do Firebase 
        const FIREBASE_URL = "https://radar-tesouro-esp32-default-rtdb.firebaseio.com/.json";
        // -----------------

        const MODO_TESTE = false; // <<< MODO 

        // Pega os elementos da página
        const distanciaEl = document.getElementById('distancia');
        const direcaoEl = document.getElementById('direcao-texto');
        const setaEl = document.getElementById('seta');
        const statusCacadorEl = document.getElementById('status-cacador');
        const statusTesouroEl = document.getElementById('status-tesouro');
        
        // --- Funções de Cálculo (Haversine) ---
        function toRad(graus) { return graus * Math.PI / 180; }
        function toDeg(radianos) { return radianos * 180 / Math.PI; }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Raio da Terra em metros
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distância em metros
        }

        function calculateBearing(lat1, lon1, lat2, lon2) {
            const y = Math.sin(toRad(lon2 - lon1)) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                      Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(toRad(lon2 - lon1));
            let brng = toDeg(Math.atan2(y, x));
            return (brng + 360) % 360; 
        }

        // 1. Pede o GPS do Tesouro
        async function fetchTesouroData() {
            try {
                const response = await fetch(FIREBASE_URL); // Pede ao Firebase
                const data = await response.json();
                
                if (data.status === "OK") {
                    statusTesouroEl.innerText = `Tesouro (LoRa): OK (Sinal: ${data.rssi})`;
                    return data; // Retorna {lat: ..., lon: ..., rssi: ...}
                } else {
                    statusTesouroEl.innerText = `Tesouro (LoRa): ${data.status}`;
                    return null;
                }
            } catch (e) {
                statusTesouroEl.innerText = "Tesouro (LoRa): Erro ao ler da nuvem!";
                return null;
            }
        }

        // 2. Função chamada quando o GPS do celular (Caçador)
        async function onGpsSuccess(posicaoCacador) {
            const cacadorLat = posicaoCacador.coords.latitude;
            const cacadorLon = posicaoCacador.coords.longitude;
            
            statusCacadorEl.innerText = `Caçador (GPS): OK (${posicaoCacador.coords.accuracy.toFixed(0)}m precisão)`;

            const posicaoTesouro = await fetchTesouroData();
            if (!posicaoTesouro) return; // Se falhar, para aqui

            // 3. Temos as duas posições! Hora de calcular.
            const distMetros = haversineDistance(cacadorLat, cacadorLon, posicaoTesouro.lat, posicaoTesouro.lon);
            const direcaoGraus = calculateBearing(cacadorLat, cacadorLon, posicaoTesouro.lat, posicaoTesouro.lon);

            // 4. Atualiza a Interface!
            distanciaEl.innerText = `${distMetros.toFixed(0)} m`; // ex: "125 m"
            direcaoEl.innerText = `Direção: ${direcaoGraus.toFixed(0)}°`;
            setaEl.style.transform = `rotate(${direcaoGraus}deg)`;
        }
        
        function onGpsError(err) {
            statusCacadorEl.innerText = "Caçador (GPS): Erro (Negou permissao?)";
            distanciaEl.innerText = "---";
        }
        
        // 3. Inicia o processo!
        function iniciarRadar() {
            if ('geolocation' in navigator) {
                // watchPosition atualiza automaticamente quando você se move
                navigator.geolocation.watchPosition(
                    onGpsSuccess, 
                    onGpsError, 
                    { enableHighAccuracy: true } // Pede a maior precisão possível
                );
            } else {
                alert("Seu navegador não suporta Geolocalização!");
            }
        }

        iniciarRadar();
    </script>
</body>
</html>
